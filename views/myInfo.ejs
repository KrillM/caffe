<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('fragments/header') %>
    <title>개인 프로필 페이지</title>
</head>
<body>
    <%- include('fragments/navbar') %>
    <form class="crewForm" name="updateNewRepImage" action="/myinfo/update/rep" method="patch" enctype="multipart/form-data">
        <div class="mb-3 row">
            <label for="representImage" class="col-sm-2 col-form-label">New My Page Image</label>
            <div class="col-sm-10">
                <input type="file" name="representImage" class="form-control" id="representImage"/>
                <div id="warning" style="color: darkgoldenrod;">선택된 파일이 없을 때 클릭하는 경우 마이 페이지 이미지가 자동으로 사라집니다.</div>
            </div>
            <div class="row mb-3">
                <label for="message" class="col-sm-2 col-form-label"></label>
                <div class="col-sm-10">
                    <div id="message4" style="color: red;"></div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="button" class="col-sm-2 col-form-label"></label>
                <div class="col-sm-10">
                    <button type="button" class="btn btn-warning" onClick="update4NewRepImage()">Update My Page Image</button>  
                </div>
            </div>
        </div>
    </form>

    <form class="crewForm" name="updateNewImage" action="/myinfo/update/image" method="patch" enctype="multipart/form-data">
        <div class="mb-3 row">
            <label for="profileImage" class="col-sm-2 col-form-label">New Profile Image</label>
            <div class="col-sm-10">
                <input type="file" name="profileImage" class="form-control" id="profileImage"/>
                <div id="warning" style="color: darkgoldenrod;">선택된 파일이 없을 때 클릭하는 경우 프로필 이미지가 자동으로 사라집니다.</div>
            </div>
            <div class="row mb-3">
                <label for="message" class="col-sm-2 col-form-label"></label>
                <div class="col-sm-10">
                    <div id="message3" style="color: red;"></div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="button" class="col-sm-2 col-form-label"></label>
                <div class="col-sm-10">
                    <button type="button" class="btn btn-warning" onClick="update4NewImage()">Update Profile Image</button>  
                </div>
            </div>
        </div>
    </form>

    <form class="crewForm" name="updateCrew" action="/myinfo/update/profile" method="patch">
        <div class="row mb-3">
            <label for="email" class="col-sm-2 col-form-label">Email</label>
            <div class="col-sm-10">
                <input type="email" name="email" class="form-control" id="email" value="<%= crew.email %>" />
                <div id="warning" style="color: darkgoldenrod;">이메일 수정 시 자동 로그아웃 됩니다.</div>
            </div>
        </div>
        <div class="row mb-3">
            <label for="nickname" class="col-sm-2 col-form-label">Nickname</label>
            <div class="col-sm-10">
                <input type="text" name="nickname" class="form-control" id="nickname" value="<%= crew.nickname %>">
            </div>
        </div>
        <div class="row mb-3">
            <label for="phoneNumber" class="col-sm-2 col-form-label">Phone Number</label>
            <div class="col-sm-10">
                <input type="text" name="phoneNumber" class="form-control" id="phoneNumber" value="<%= crew.phoneNumber %>"/>
            </div>
        </div>
        <div class="row mb-3">
            <label for="nickname" class="col-sm-2 col-form-label">Short Introduction</label>
            <div class="col-sm-10">
                <% if(user.bio === null){ %>
                    <input type="text" name="bio" class="form-control" id="bio" placeholder="간단한 자기 소개를 해보세요."/>
                <% } else { %>
                    <input type="text" name="bio" class="form-control" id="bio" value="<%= crew.bio %>"/>
                <% } %>
            </div>
        </div>
        <div class="row mb-3">
            <label for="message" class="col-sm-2 col-form-label"></label>
            <div class="col-sm-10">
                <div id="message" style="color: red;"></div>
            </div>
        </div>
        <div class="row mb-3">
            <label for="button" class="col-sm-2 col-form-label"></label>
            <div class="col-sm-10">
                <button type="button" class="btn btn-warning" onClick="updateUser()">Update Profile</button>
            </div>
        </div>
    </form>

    <form class="crewForm" name="updatePassword" action="/myinfo/update/password" method="patch">
        <div class="row mb-3">
            <label for="password" class="col-sm-2 col-form-label">Password</label>
            <div class="col-sm-10">
                <input type="password" name="password" class="form-control" id="password" placeholder="8~16글자 사이이며 대소문자, 숫자, 특수문자는 필수입니다."/>
            </div>
        </div>
        <div class="row mb-3">
            <label for="passwordConfirm" class="col-sm-2 col-form-label">Password Confirm</label>
            <div class="col-sm-10">
                <input type="password" name="passwordConfirm" class="form-control" id="passwordConfirm" placeholder="비밀번호를 똑같이 입력해주세요."/>
            </div>
        </div>
        <div class="row mb-3">
            <label for="message" class="col-sm-2 col-form-label"></label>
            <div class="col-sm-10">
                <div id="message2" style="color: red;"></div>
            </div>
        </div>
        <div class="row mb-3">
            <label for="button" class="col-sm-2 col-form-label"></label>
            <div class="col-sm-10">
                <button type="button" class="btn btn-warning" onClick="update2NewPassword()">Update Password</button>
            </div>
        </div>
    </form>

    <form class="crewForm" name="buttons">
        <div class="row mb-3">
            <label for="button" class="col-sm-2 col-form-label"></label>
            <div class="col-sm-10">
                <button type="button" class="btn btn-info" onClick="updateCancel()">Cancel</button>
                <button type="button" class="btn btn-danger" onClick="deleteUser()">Delete</button>
            </div>
        </div>
    </form>
    <%- include('fragments/footer') %>
    <%- include('fragments/footerJs') %>

    <script>
        const err4 = document.getElementById("message4");

        const update4NewRepImage = async () => {
            const form = document.forms["updateNewRepImage"];
            const formData = new FormData();
            formData.append("representImage", form.representImage.files[0]);

            try {
                const response = await axios.patch('/myinfo/update/rep', formData);
        
                if (response.data === 'ok') {
                    err4.innerHTML = '마이페이지 대표 이미지가 수정 되었습니다.';
                    setTimeout(() => {
                        err4.innerHTML = '';
                        document.location.href = '/crewpage/<%= crew.nickname %>';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                err3.innerHTML = error.response.data;
                setTimeout(() => {
                    err3.innerHTML = '';
                }, 2000);
            }
        }

        const err3 = document.getElementById("message3");

        const update4NewImage = async () => {
            const form = document.forms["updateNewImage"];
            const formData = new FormData();
            formData.append("profileImage", form.profileImage.files[0]);

            try {
                const response = await axios.patch('/myinfo/update/image', formData);
        
                if (response.data === 'ok') {
                    err3.innerHTML = '프로필 이미지가 수정 되었습니다.';
                    setTimeout(() => {
                        err3.innerHTML = '';
                        document.location.href = '/crewpage/<%= crew.nickname %>';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                err3.innerHTML = error.response.data;
                setTimeout(() => {
                    err3.innerHTML = '';
                }, 2000);
            }
        }

        const err = document.getElementById("message");
      
        const updateUser = async () => {
            const email = document.getElementById("email").value;
            const nickname = document.getElementById("nickname").value;
            const phoneNumber = document.getElementById("phoneNumber").value;
            const bio = document.getElementById("bio").value;
        
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(email)) {
                return (err.innerHTML = "이메일 형식을 확인해주세요.");
            }
                    
            if (nickname.length < 2 || nickname.length > 20) {
                return (err.innerHTML = '닉네임은 두 글자 이상 20글자 이하여야 합니다.');
            }
        
            const phoneNumberRegex = /^\d+$/;
            if (!phoneNumberRegex.test(phoneNumber) || phoneNumber.includes('-')) {
                return (err.innerHTML = '전화번호는 숫자만 입력하고, -를 사용하지 않아야 합니다.');
            }
            
            if(bio.length > 100){
                return (err.innerHTML = '간단한 자기소개는 100자 이상 적을 수 없습니다.');
            }
            const user = {
                email,
                nickname,
                phoneNumber,
                bio,
            };

            try {
                const response = await axios.patch(`/myinfo/update/profile`, user);
        
                if (response.data === "ok") {
                    err.innerHTML = '프로필이 수정 되었습니다.';
                    setTimeout(() => {
                        err.innerHTML = '';
                        document.location.href = '/crewpage/<%= crew.nickname %>';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                err.innerHTML = error.response.data;
                setTimeout(() => {
                    err.innerHTML = '';
                }, 2000);
            }
        };

        const err2 = document.getElementById("message2");

        const update2NewPassword = async () => {
            const password = document.getElementById("password").value;
            const passwordConfirm = document.getElementById("passwordConfirm").value;

            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,16}$/;
            if (!passwordRegex.test(password)) {
                return (err2.innerHTML ='비밀번호는 8~16글자 사이이며, 대문자, 소문자, 특수문자, 숫자를 모두 포함해야 합니다.');
            }
        
            if (password !== passwordConfirm) {
                return (err2.innerHTML = '비밀번호가 일치하지 않습니다.');
            }

            const user = {
                password,
            };

            try {
                const response = await axios.patch(`/myinfo/update/password`, user);
        
                if (response.data === "ok") {
                    err2.innerHTML = '비밀번호가 수정 되었습니다.';
                    setTimeout(() => {
                        err2.innerHTML = '';
                        document.location.href = '/crewpage/<%= crew.nickname %>';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error:', error);
                err2.innerHTML = error.response.data;
                setTimeout(() => {
                    err2.innerHTML = '';
                }, 2000);
            }
        }

        const updateCancel = () => {
            history.back();
        };

        function deleteUser(){
            axios({
                method: 'delete',
                url: `/myinfo/delete`
            }).then((res) => {
                alert("더 이상 회원이 아닙니다.");
                location.href = "/";
            }).catch((err) => {
                alert("회원 탈퇴가 불가능합니다.");
            })
        }
    </script>
</body>
</html>